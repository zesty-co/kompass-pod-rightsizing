apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "recommendations-maker.name" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    app: {{ include "recommendations-maker.name" . }}
    {{- include "pod-rightsizing.labels" . | nindent 4 }}
    {{- with .Values.additionalLabels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  replicas: {{ .Values.recommendationsMaker.replicaCount | default 1 }}
  selector:
    matchLabels:
      app: {{ include "recommendations-maker.name" . }}
  template:
    metadata:
      labels:
        app: {{ include "recommendations-maker.name" . }}
        {{- with .Values.additionalLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
    spec:
      {{- if .Values.recommendationsMaker.priorityClassName }}
      priorityClassName: {{ .Values.recommendationsMaker.priorityClassName }}
      {{- end }}
      {{- if .Values.global.nodeSelector }}
      nodeSelector:
      {{- toYaml .Values.global.nodeSelector | nindent 8 }}
      {{- end }}
      {{- if .Values.global.tolerations }}
      tolerations:
      {{- toYaml .Values.global.tolerations | nindent 8 }}
      {{- end }}
      containers:
        - name: {{ .Values.recommendationsMaker.name }}
          image: {{ .Values.registry }}{{ .Values.recommendationsMaker.image.name }}:{{ .Values.recommendationsMaker.image.tag  | default .Chart.AppVersion }}
          imagePullPolicy: {{ .Values.imagePullPolicy | default "Always" }}
          {{- if .Values.recommendationsMaker.image.args }}
          args: {{ toYaml .Values.recommendationsMaker.image.args | nindent 10 }}
          {{- end }}
          env:
            - name: CM_NAME
              value: {{ include "kompass-pod-rightsizing-config.name" . }}
            - name: CM_NAMESPACE
              value: {{ .Release.Namespace }}
            - name: LEADER_ELECTION_ENABLED
              value: "{{ .Values.recommendationsMaker.leaderElection.enabled }}"
            - name: VM_URL
              value: {{ include "pod-rightsizing.victoriaMetrics.url" . }}
            - name: SAVE_QUERIES_TO_FILES
              value: "false"
            - name: CONTAINER_NAME
              value: {{ .Values.recommendationsMaker.name }}
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            {{- if and .Values.global.cxLogging .Values.global.cxLogging.enabled }}
            - name: CX_API_KEY
              value: {{ .Values.global.cxLogging.apiKey }}
            - name: CX_CLUSTER_NAME
              value: {{ .Values.global.cxLogging.clusterName }}
            - name: CORALOGIX_LOG_URL
              value: {{ .Values.global.cxLogging.logUrl | default "https://ingress.eu2.coralogix.com:443/api/v1/logs" }}
            - name: CORALOGIX_TIME_DELTA_URL
              value: {{ .Values.global.cxLogging.timeDeltaUrl | default "https://ingress.eu2.coralogix.com:443/sdk/v1/time" }}
            - name: CORALOGIX_METRICS_URL
              value: {{ .Values.global.cxLogging.metricsUrl }}
            {{- else if and .Values.cxLogging .Values.cxLogging.enabled }}
            - name: CX_API_KEY
              value: {{ .Values.cxLogging.apiKey }}
            - name: CX_CLUSTER_NAME
              value: {{ .Values.cxLogging.clusterName }}
            - name: CORALOGIX_LOG_URL
              value: {{ .Values.cxLogging.logUrl | default "https://ingress.eu2.coralogix.com:443/api/v1/logs" }}
            - name: CORALOGIX_TIME_DELTA_URL
              value: {{ .Values.cxLogging.timeDeltaUrl | default "https://ingress.eu2.coralogix.com:443/sdk/v1/time" }}
            - name: CORALOGIX_METRICS_URL
              value: {{ .Values.cxLogging.metricsUrl }}
            {{- end }}
            {{- if and .Values.config .Values.config.excludeNamespaces }}
            - name: EXCLUDE_NAMESPACES
              value: {{ .Values.config.excludeNamespaces | toJson | quote }}
            {{- end }}
          volumeMounts:
            - mountPath: /recommendations-data
              name: recommendations-storage
          {{- include "pod-rightsizing.recommendationsMaker.resources" . | nindent 10 }}
          ports:
            - containerPort: 8088
              name: http
              protocol: TCP
      volumes:
        - name: recommendations-storage
          emptyDir: {}
      {{- $globalPullSecrets := list }}
      {{- if .Values.global.imagePullSecret.name }}
      {{- $globalPullSecrets = append $globalPullSecrets (dict "name" .Values.global.imagePullSecret.name) }}
      {{- end }}
      {{- range .Values.global.imagePullSecrets }}
      {{- $globalPullSecrets = append $globalPullSecrets . }}
      {{- end }}
      {{- $pullSecrets := $globalPullSecrets }}
      {{- if and (hasKey .Values "imagePullSecrets") (gt (len .Values.imagePullSecrets) 0) }}
      {{- $pullSecrets = .Values.imagePullSecrets }}
      {{- end }}
      {{- if hasKey .Values.recommendationsMaker "imagePullSecrets" }}
      {{- $pullSecrets = .Values.recommendationsMaker.imagePullSecrets }}
      {{- end }}
      {{- if $pullSecrets }}
      imagePullSecrets:
        {{- toYaml $pullSecrets | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "pod-rightsizing.serviceAccountName" . }}
